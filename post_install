#!/usr/bin/env bash

# mkdir ~/.dotfiles.local &> /dev/null
# pushd ~/.dotfiles.local

# install nnn plugin if nnn exists
if command -v nnn &> /dev/null; then
    if [ ! -d "${XDG_CONFIG_HOME:-$HOME/.config}/nnn/plugins" ] || [ -z "$(ls ${XDG_CONFIG_HOME:-$HOME/.config}/nnn/plugins)" ]; then
        echo "installing nnn plugins"
        bash -c "$(curl -Ls https://raw.githubusercontent.com/jarun/nnn/master/plugins/getplugs)"
    fi
fi

# install fzf if ~/.fzf/install exists
if ! command -v fzf &> /dev/null; then
    if [ -f ~/.fzf/install ]; then
        ~/.fzf/install --all
    fi
fi

# create symlinks from ~/.dotfiles.local/ to ~/
if [ -d ~/.dotfiles.local ]; then
    for file in $(find ~/.dotfiles.local -type f); do
        ln -sf $file "$(echo "$file" | sed 's/\.dotfiles\.local\///')"
    done
fi

# copy files from to Windows Drive C:\
# if grep -qEi "(Microsoft|WSL)" /proc/version &> /dev/null; then
#     rm -rf /mnt/c/.dotfiles &> /dev/null
#     if [ ! -f /mnt/c/.dotfiles ]; then
#         cp -rL ~/.dotfiles/windows /mnt/c/.dotfiles
#     fi
# fi

# vim requirements
if command -v pip3 &> /dev/null; then
    pip3 install pynvim > /dev/null
fi
if [ ! -d ~/.cache/vim/undo ]; then
    mkdir -p ~/.cache/vim/undo
fi

function apply_diff_for_submodule() {
    local target_folder=./submodules/$1
    local diff_list=(./submodules_diff/$1/*.diff)
    if [[ -d $target_folder ]]; then
        for diff_file in "${diff_list[@]}"; do
            diff_file_realpath=$(realpath $diff_file)
            (cd $target_folder && git reset --hard HEAD &> /dev/null && git apply $diff_file_realpath &> /dev/null)
            if [[ $? -eq 0 ]]; then
                echo "Apply patch $diff_file in folder $target_folder succeeded."
            else
                echo "Error: apply patch $diff_file in folder $target_folder failed."
            fi
        done
    fi
}
apply_diff_for_submodule fzf > /dev/null
